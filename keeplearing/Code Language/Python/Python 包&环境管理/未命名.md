
产品进行国产化操作系统移植时，由于 Python 包、环境管理工具五花八门，移植起来并没有像 Golang 那样方便。后来又接触到 Rust 的 Cargo 包管理工具，觉得非常便利。故灵机一动，决定在网上寻找

开发过程中接触到了 Go Modules 和 Rust Cargo 两种包管理工具，作为 Python 程序员的我觉得甚是好用。于是准备上网找到一种类似于上述两种工具的 Python 包、环境管理工具。

## 介绍
uv 是由 Astral 公司开发，用 Rust 编写的快速 Python 包管理器。它最初作为 pip 工作流的替代品推出，如今已扩展成为一个端到端的解决方案，能够管理 Python 项目、命令行工具、单文件脚本甚至 Python 本身。uv 就像是 Python 界的 Cargo，为开发者提供了一个快速、可靠、易用的统一接口。

uv 具有多项突出的特性。在端到端项目管理方面，通过 `uv run`、`uv lock` 和 `uv sync` 等命令，可以基于标准元数据生成跨平台的锁文件，并从中安装依赖，性能比 Poetry、PDM 和 Rye 等工具更高。在工具管理方面，`uv tool install` 和 `uv tool run`（别名 uvx）可以在隔离的虚拟环境中安装命令行工具，并无需显式安装即可执行一次性命令，速度比 pipx 更快。此外，uv 还支持 Python 安装，通过 `uv python install` 可以自动下载安装 Python，类似 pyenv 但更高效。对于单文件脚本，uv 支持基于 PEP 723 的内联元数据，只需 `uv run` 即可执行独立的 Python 脚本。

所有这些功能都基于 uv 极快的跨平台依赖解析器。uv 在性能和可靠性上都有突出的优势，无论是小型脚本还是大型项目，从初学者到专家，都能很好地满足 Python 开发的各种需求。
## 安装
- 安装 uv
    
    uv 可以通过多种方式进行安装，如下：
    
    - 使用 curl： `curl -LsSf <https://astral.sh/uv/install.sh> |sh`
    - 使用 pip： `pip install uv`
    - 使用 pipx：`pipx install uv`
    
    <aside> 💡
    
    更多安装方式见官方文档：[https://docs.astral.sh/uv/getting-started/installation/](https://docs.astral.sh/uv/getting-started/installation/)
    
    </aside>
## 使用示例
- 管理 Python 项目
    
    - 初始化项目：可以使用 `uv init` 命令初始化一个 Python 项目。
        
        ```bash
        uv init your_project_name
        
        # 初始化项目时也可以指定 python 版本
        uv init --python=3.12
        # 如果当前 shell 的解释器不是3.12，需要切换到3.12或者使用 venv
        uv venv python=3.12
        ```
        
        项目结构如下：
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/20472f87-5a66-4767-a1db-8ad8f79b8fd9/c2710a60-ac82-4f0a-8896-26b103cf36f5/image.png)
        
        - uv.lock 是锁定的依赖，类似于 `pip freeze`
        - pyproject.toml 是项目的配置文件，里面有依赖的版本信息和 python 版本信息
        
        例如，`uv init && uv add "fastapi>=0.112"`会初始化项目并添加 fastapi 依赖，生成如下 pyproject.toml 文件：
        
        ```toml
        [project]
        name = "hello-world"
        version = "0.1.0"
        readme = "README.md"
        dependencies = ["fastapi>=0.112"]
        ```
        
    - 添加依赖：通过 `uv add` 命令可以添加项目依赖
        
        ```bash
        uv add requests
        ```
        
        通过 uv 安装包, 会进一步更新 lock 文件, 也会更新 pyproject.toml 文件, 当迁移项目时，只需要将这两个文件拷贝到新环境即可.
        
    - 生成锁文件：uv 会基于项目依赖创建一个锁文件 uv.lock ，保证项目环境在不同机器上的一致性.
        
    - 执行命令：通过 `uv run` 可以在项目环境中执行命令，无需手动激活虚拟环境。
        
        ```bash
        uv run hello.py
        ```
        
        <aside> 💡
        
        这里要特别说明, 使用 uv 管理的项目，都要使用`uv run xxx.py`来运行，而不是直接使用`python xxx.py`, 因为 uv 会自动激活虚拟环境，而 python 不会。
        
        </aside>
        
- 创建虚拟环境
    
    创建环境：
    
    ```bash
    # 创建虚拟环境，不加环境路径的话默认是保存在当前的.venv目录下
    uv venv 
    
    # 指定环境保存目录
    uv venv /path/to/venv
    
    # 指定Python版本，注意需要对应版本的Python已经安装
    uv venv -p 3.12
    
    # --python 同 -p
    uv venv --python 3.12
    ```
    
    注意：uv 工具不会自动下载 Python 包，因此如果设置`-p`时指定系统不存在的 Python 版本，则会报下面的错：
    
    ```bash
    $ uv venv -p 3.13
    No Python 3.13 In `PATH`. Is Python 3.13 installed?
    ```
    
    启用环境的命令同 Python 的标准库 venv :
    
    ```bash
    # Unix
    source venv/bin/activate
    
    # Windows
    venv\\Scripts\\activate
    ```
    
- uv 原生命令和 pip 兼容命令
    
    uv 设计兼容 pip 命令，很好记。在普通的 `pip install` 前面加一个 uv ，大部分 `pip install` 的参数都支持：
    
    - 安装包
        
        ```bash
        # 原生命令
        uv add requests pandas        # 安装包
        uv add requests==2.31.0      # 指定版本
        
        # pip 兼容
        uv pip install requests pandas
        uv pip install requests==2.31.0
        ```
        
        一个非常重要的点：uv 默认不会读`pip.conf`这种类型的镜像配置，因此在国内的话，包的默认下载速度是比较慢的，需要手动加`--index-url/-i`和`-extra-index-url`，才能达到比较快的下载速度。
        
    - 卸载包
        
        ```bash
        # 原生命令
        uv remove requests           # 卸载包
        
        # pip 兼容
        uv pip uninstall requests
        ```
        
    - 同步依赖
        
        ```bash
        # 原生命令
        uv sync                     # 同步依赖
        
        # pip 兼容
        uv pip sync                 # pip-sync 兼容模式
        ```
        
        拿到 requirements.txt 后，就可以用 uv pip sync 命令来将其中的版本信息更新到当前的虚拟环境
        
        ```bash
        uv pip sync requirements.txt
        ```
        
        但需要注意一点，uv 的 requirements.txt 并不是跨平台的，也就是 Windows 上的requirements.txt 并不适用于 Linux 环境，反之亦然。因此最好还是在相同的操作系统之间执行 `uv pip sync`，不同操作系统之间可能需要手动修改 requirement.txt 。
        
    - 导出依赖
        
        ```bash
        # 原生命令
        uv requirements             # 导出依赖
        
        # pip 兼容
        uv pip freeze              # 导出依赖
        ```
        
    - 编译依赖
        
        ```bash
        # 原生命令
        uv compile requirements.in  # 编译依赖
        
        # pip 兼容
        uv pip compile requirements.in
        ```
        
        利用`uv pip compile`，可以方便地将当前环境所有安装的包以及它们的依赖的版本都导出到requirements.txt 中，然后在别的机器上快速复现同样的安装环境。
        
    
    一般建议：
    
    - 优先使用原生命令（更快、更简洁）
    - 需要特殊 pip 选项时使用 pip 兼容命令
- 管理命令行工具
    
    - 安装：通过 `uv tool install` 可以把命令行工具（如 Ruff）安装到隔离的虚拟环境中。
    - 执行一次性命令：通过 `uvx`（uv tool run 的别名）可以直接执行命令而无需安装，例如 `uvx ruff check`。
- 执行单文件脚本
    
    - 对于没有包含任何元数据但有依赖的脚本，如 `main.py`，可以通过`uv add --script main.py 'requests<3' 'rich'`将依赖声明嵌入到脚本中。
    - 然后使用 `uv run main.py` 即可在隔离环境中执行脚本并自动安装依赖。
## 优势
- **pip-tools**：uv 在没有缓存的情况下比 pip-tools 快 8 - 10 倍，在有热缓存的情况下快 80 - 115 倍。pip-tools 的依赖关系解析功能相对较弱，而 uv 可以基于标准元数据生成跨平台的锁文件，保证项目环境的一致性。
- **pipx**：在工具管理方面，uv 的 `uv tool install` 和 `uvx`（uv tool run 的别名）可以在隔离的虚拟环境中安装命令行工具，速度比 pipx 更快。无需显式安装即可执行一次性命令，为开发者提供了更加便捷的工具使用方式。
- **poetry**：uv 在端到端项目管理方面与 Poetry 类似，但性能更高。Poetry 预先解析完整的依赖图，并按拓扑顺序安装依赖项，依据 pyproject.toml 管理项目内外的虚拟环境，还会生成 poetry.lock 文件确保项目的复用。然而，Poetry 的解析速度较慢，部分是因为 Python 包声明支持库的方式不一致，可能会导致支持库解析的时间较长。
- **pyenv**：uv 在 Python 安装方面，通过 `uv python install` 可以自动下载安装 Python，类似 pyenv 但更高效。pyenv 主要用于切换 Python 版本，并不直接管理虚拟环境，而 uv 不仅可以管理 Python 版本，还能全面管理 Python 项目、命令行工具和单文件脚本。
- **virtualenv**：uv 旨在作为 pip、pip-tools 和 virtualenv 的直接替代品，在性能和功能上都有很大的提升。uv 比 virtualenv 创建虚拟环境的速度更快，例如，uv 比 python -m venv 快 80 倍，比 virtualenv 快 7 倍，且不依赖于 Python。同时，uv 支持更多高级功能，如跨平台依赖解析、工具管理和脚本执行等。
## 总结
uv 作为一款强大的 Python 包管理工具，其功能强大、简单易用的特点在众多方面得到了充分体现。无论是端到端项目管理、工具管理、Python 安装还是脚本执行，uv 都展现出了卓越的性能和可靠性。

在端到端项目管理方面，uv 通过 `uv run`、`uv lock` 和 `uv sync` 等命令，能够基于标准元数据生成跨平台的锁文件，并从中安装依赖。这一功能使得大型项目的依赖安装和解析更加快速，提高了开发效率，同时也保证了项目环境在不同机器上的一致性，为团队协作提供了便利。

在工具管理方面，`uv tool install` 和 `uvx`（uv tool run 的别名）可以在隔离的虚拟环境中安装命令行工具，速度比 pipx 更快。无需显式安装即可执行一次性命令，为开发者提供了更加便捷的工具使用方式。

`uv python install` 在 Python 安装方面有着独特的优势，可以自动下载安装 Python，类似 pyenv 但更高效。这使得开发者在搭建开发环境时更加轻松快捷，无需繁琐的手动操作。

对于单文件脚本，uv 支持基于 PEP 723 的内联元数据，只需 `uv run` 即可执行独立的 Python 脚本。对于没有包含任何元数据但有依赖的脚本，也可以通过 uv add 将依赖声明嵌入到脚本中，然后使用 `uv run` 在隔离环境中执行脚本，自动安装所需依赖。

综上所述，uv 作为 Python 包管理工具，功能强大、简单易用，降低了 Python 开发的复杂度，提高了生产力。无论是小型脚本还是大型项目，从初学者到专家，uv 都能很好地满足 Python 开发的各种需求。如果你还在为 Python 包管理而烦恼，不妨试试 uv，相信它会给你带来全新的开发体验。
